{% extends "base.html" %}

{% block title %}Settings - PharmaStock{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>‚öôÔ∏è Settings</h1>
    
    <div class="card">
        <div class="card-header">Company Credentials</div>
        
        <div id="credentialsStatus" class="loading">Loading...</div>
        
        <form id="credentialsForm">
            <h3>NILA</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="nilaUsername" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="nilaPassword" required>
            </div>
            <button type="button" onclick="testCredentials('NILA')" class="btn btn-primary">Test Connection</button>
            <button type="button" onclick="deleteCredentials('NILA')" class="btn btn-danger" id="deleteNilaBtn" style="display: none; margin-left: 10px;">üóëÔ∏è Delete</button>
            
            <h3 style="margin-top: 30px;">DAIMA</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="daimaUsername" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="daimaPassword" required>
            </div>
            <button type="button" onclick="testCredentials('DAIMA')" class="btn btn-primary">Test Connection</button>
            <button type="button" onclick="deleteCredentials('DAIMA')" class="btn btn-danger" id="deleteDaimaBtn" style="display: none; margin-left: 10px;">üóëÔ∏è Delete</button>
            
            <div style="margin-top: 30px;">
                <button type="submit" class="btn btn-success">Save All Settings</button>
            </div>
        </form>
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        loadCredentialsStatus();
        checkAdminStatus();
    });
    
    function checkAdminStatus() {
        const isAdmin = localStorage.getItem('is_admin') === 'true';
        const isUserAdmin = localStorage.getItem('is_user_admin') === 'true';
        
        // Show delete buttons for admins or user_admins
        if (isAdmin || isUserAdmin) {
            document.getElementById('deleteNilaBtn').style.display = 'inline-block';
            document.getElementById('deleteDaimaBtn').style.display = 'inline-block';
        }
    }
    
    async function loadCredentialsStatus() {
        try {
            const data = await apiRequest('/api/credentials/status');
            if (data.success) {
                const status = data.credentials;
                
                if (status.NILA.configured) {
                    document.getElementById('nilaUsername').value = status.NILA.username;
                }
                if (status.DAIMA.configured) {
                    document.getElementById('daimaUsername').value = status.DAIMA.username;
                }
                
                document.getElementById('credentialsStatus').innerHTML = 
                    `<p>NILA: ${status.NILA.configured ? '‚úÖ Configured' : '‚ùå Not configured'}</p>
                     <p>DAIMA: ${status.DAIMA.configured ? '‚úÖ Configured' : '‚ùå Not configured'}</p>`;
            }
        } catch (error) {
            console.error('Error loading credentials status:', error);
        }
    }
    
    async function testCredentials(company) {
        const username = document.getElementById(`${company.toLowerCase()}Username`).value;
        const password = document.getElementById(`${company.toLowerCase()}Password`).value;
        
        if (!username || !password) {
            alert('Please enter username and password');
            return;
        }
        
        try {
            const result = await apiRequest('/api/credentials/test', {
                method: 'POST',
                body: JSON.stringify({
                    company,
                    username,
                    password
                })
            });
            
            if (result.success) {
                alert(`‚úÖ ${company} credentials are valid!`);
            } else {
                alert(`‚ùå ${company} credentials failed: ${result.message}`);
            }
        } catch (error) {
            alert(`Error testing credentials: ${error.message}`);
        }
    }
    
    document.getElementById('credentialsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const nilaUsername = document.getElementById('nilaUsername').value;
        const nilaPassword = document.getElementById('nilaPassword').value;
        const daimaUsername = document.getElementById('daimaUsername').value;
        const daimaPassword = document.getElementById('daimaPassword').value;
        
        try {
            // Save NILA credentials
            if (nilaUsername && nilaPassword) {
                const nilaResult = await apiRequest('/api/credentials/save', {
                    method: 'POST',
                    body: JSON.stringify({
                        company: 'NILA',
                        username: nilaUsername,
                        password: nilaPassword
                    })
                });
                
                if (!nilaResult.success) {
                    alert(`Failed to save NILA credentials: ${nilaResult.message}`);
                    return;
                }
            }
            
            // Save DAIMA credentials
            if (daimaUsername && daimaPassword) {
                const daimaResult = await apiRequest('/api/credentials/save', {
                    method: 'POST',
                    body: JSON.stringify({
                        company: 'DAIMA',
                        username: daimaUsername,
                        password: daimaPassword
                    })
                });
                
                if (!daimaResult.success) {
                    alert(`Failed to save DAIMA credentials: ${daimaResult.message}`);
                    return;
                }
            }
            
            alert('‚úÖ Credentials saved successfully!');
            loadCredentialsStatus();
        } catch (error) {
            alert(`Error saving credentials: ${error.message}`);
        }
    });
    
    async function deleteCredentials(company) {
        const confirmed = confirm(`Are you sure you want to delete ${company} credentials? This action cannot be undone.`);
        if (!confirmed) {
            return;
        }
        
        try {
            const result = await apiRequest(`/api/credentials/delete?company=${company}`, {
                method: 'DELETE'
            });
            
            if (result.success) {
                alert(`‚úÖ ${company} credentials deleted successfully!`);
                // Clear the form fields
                document.getElementById(`${company.toLowerCase()}Username`).value = '';
                document.getElementById(`${company.toLowerCase()}Password`).value = '';
                // Reload status
                loadCredentialsStatus();
            } else {
                alert(`‚ùå Failed to delete ${company} credentials: ${result.message || 'Unknown error'}`);
            }
        } catch (error) {
            if (error.message.includes('403') || error.message.includes('Forbidden')) {
                alert('‚ùå Only admins can delete credentials.');
            } else {
                alert(`Error deleting credentials: ${error.message}`);
            }
        }
    }
</script>
{% endblock %}

