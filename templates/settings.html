{% extends "base.html" %}

{% block title %}Settings - PharmaStock{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>⚙️ Settings</h1>
    
    <div class="card">
        <div class="card-header">Company Credentials</div>
        
        <div id="credentialsStatus" class="loading">Loading...</div>
        
        <form id="credentialsForm">
            <h3>NILA</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="nilaUsername" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="nilaPassword" required>
            </div>
            <button type="button" onclick="testCredentials('NILA')" class="btn btn-primary">Test Connection</button>
            
            <h3 style="margin-top: 30px;">DAIMA</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="daimaUsername" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="daimaPassword" required>
            </div>
            <button type="button" onclick="testCredentials('DAIMA')" class="btn btn-primary">Test Connection</button>
            
            <div style="margin-top: 30px;">
                <button type="submit" class="btn btn-success">Save All Settings</button>
            </div>
        </form>
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        loadCredentialsStatus();
    });
    
    async function loadCredentialsStatus() {
        try {
            const data = await apiRequest('/api/credentials/status');
            if (data.success) {
                const status = data.credentials;
                
                if (status.NILA.configured) {
                    document.getElementById('nilaUsername').value = status.NILA.username;
                }
                if (status.DAIMA.configured) {
                    document.getElementById('daimaUsername').value = status.DAIMA.username;
                }
                
                document.getElementById('credentialsStatus').innerHTML = 
                    `<p>NILA: ${status.NILA.configured ? '✅ Configured' : '❌ Not configured'}</p>
                     <p>DAIMA: ${status.DAIMA.configured ? '✅ Configured' : '❌ Not configured'}</p>`;
            }
        } catch (error) {
            console.error('Error loading credentials status:', error);
        }
    }
    
    async function testCredentials(company) {
        const username = document.getElementById(`${company.toLowerCase()}Username`).value;
        const password = document.getElementById(`${company.toLowerCase()}Password`).value;
        
        if (!username || !password) {
            alert('Please enter username and password');
            return;
        }
        
        try {
            const result = await apiRequest('/api/credentials/test', {
                method: 'POST',
                body: JSON.stringify({
                    company,
                    username,
                    password
                })
            });
            
            if (result.success) {
                alert(`✅ ${company} credentials are valid!`);
            } else {
                alert(`❌ ${company} credentials failed: ${result.message}`);
            }
        } catch (error) {
            alert(`Error testing credentials: ${error.message}`);
        }
    }
    
    document.getElementById('credentialsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const nilaUsername = document.getElementById('nilaUsername').value;
        const nilaPassword = document.getElementById('nilaPassword').value;
        const daimaUsername = document.getElementById('daimaUsername').value;
        const daimaPassword = document.getElementById('daimaPassword').value;
        
        try {
            // Save NILA credentials
            if (nilaUsername && nilaPassword) {
                const nilaResult = await apiRequest('/api/credentials/save', {
                    method: 'POST',
                    body: JSON.stringify({
                        company: 'NILA',
                        username: nilaUsername,
                        password: nilaPassword
                    })
                });
                
                if (!nilaResult.success) {
                    alert(`Failed to save NILA credentials: ${nilaResult.message}`);
                    return;
                }
            }
            
            // Save DAIMA credentials
            if (daimaUsername && daimaPassword) {
                const daimaResult = await apiRequest('/api/credentials/save', {
                    method: 'POST',
                    body: JSON.stringify({
                        company: 'DAIMA',
                        username: daimaUsername,
                        password: daimaPassword
                    })
                });
                
                if (!daimaResult.success) {
                    alert(`Failed to save DAIMA credentials: ${daimaResult.message}`);
                    return;
                }
            }
            
            alert('✅ Credentials saved successfully!');
            loadCredentialsStatus();
        } catch (error) {
            alert(`Error saving credentials: ${error.message}`);
        }
    });
</script>
{% endblock %}

