{% extends "base.html" %}

{% block title %}Dashboard - PharmaStock{% endblock %}

{% block extra_css %}
<style>
    /* Progress Modal */
    .progress-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        pointer-events: none; /* Allow clicks through backdrop */
    }
    
    .progress-modal.show {
        display: flex;
    }
    
    .progress-modal.show .progress-content {
        pointer-events: auto; /* Re-enable clicks on modal content */
    }
    
    .progress-content {
        background: white;
        border-radius: 10px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .progress-header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .progress-header button {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        margin-left: auto;
        padding: 0 10px;
        line-height: 1;
    }
    
    .progress-header button:hover {
        color: #333;
    }
    
    .progress-bar-container {
        width: 100%;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 15px;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 12px;
    }
    
    .progress-message {
        font-size: 16px;
        color: #666;
        margin-bottom: 10px;
        min-height: 24px;
        font-weight: 500;
    }
    
    .progress-details {
        font-size: 14px;
        color: #999;
        margin-top: 10px;
        line-height: 1.6;
    }
    
    .progress-time {
        font-size: 12px;
        color: #999;
        margin-top: 10px;
        font-style: italic;
    }
    
    .progress-steps {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
    }
    
    .progress-step {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .progress-step.active {
        color: #667eea;
        font-weight: 500;
    }
    
    .progress-step.completed {
        color: #28a745;
    }
    
    .progress-step.pending {
        color: #999;
    }
    
    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .dashboard-header h1 {
        color: #333;
        font-size: 32px;
    }
    
    .refresh-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .refresh-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .btn-refresh {
        padding: 12px 24px;
        background: #28a745 !important;
        color: white !important;
        border: none !important;
        border-radius: 5px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
        display: inline-block;
    }
    
    .btn-refresh:hover {
        background: #218838 !important;
    }
    
    .btn-refresh:disabled {
        background: #6c757d !important;
        cursor: not-allowed;
    }
    
    button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-block;
    }
    
    button.btn-primary {
        background: #667eea;
        color: white;
    }
    
    button.btn-success {
        background: #28a745;
        color: white;
    }
    
    button.btn-danger {
        background: #dc3545;
        color: white;
    }
    
    button.btn-warning {
        background: #ffc107;
        color: #333;
    }
    
    .refresh-status {
        color: #666;
        font-size: 14px;
    }
    
    .section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .section-title {
        font-size: 24px;
        color: #333;
        font-weight: 600;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }
    
    th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    tr:hover {
        background: #f8f9fa;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .empty {
        text-align: center;
        padding: 40px;
        color: #999;
    }
    
    .priority-item-recent {
        background-color: #d4edda !important; /* Light green background */
        border-left: 4px solid #28a745 !important; /* Green border */
    }
    
    .priority-item-recent:hover {
        background-color: #c3e6cb !important; /* Slightly darker green on hover */
    }
    
    .priority-item-recent input[type="checkbox"] {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .priority-item-recent .order-quantity-input {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .priority-item-recent {
        background: #d4edda !important;
    }
    
    .order-qty-input {
        transition: background-color 0.2s, border-color 0.2s;
    }
    
    .order-qty-input:disabled {
        background-color: #e9ecef !important;
        cursor: not-allowed !important;
        opacity: 0.7;
    }
    
    .order-qty-input:enabled {
        background-color: #fff !important;
        cursor: text !important;
        border-color: #007bff !important;
    }
    
    .order-qty-input:enabled:focus {
        border-color: #0056b3 !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }
    
    /* Procurement Modal Styles */
    .procurement-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    
    .procurement-modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .procurement-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .procurement-modal-header h2 {
        margin: 0;
        color: #333;
    }
    
    .close-procurement-modal {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: none;
    }
    
    .close-procurement-modal:hover,
    .close-procurement-modal:focus {
        color: #000;
    }
    
    .procurement-form-group {
        margin-bottom: 20px;
    }
    
    .procurement-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    .procurement-form-group input[type="text"],
    .procurement-form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .supplier-search-container {
        position: relative;
    }
    
    .supplier-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
    }
    
    .supplier-dropdown-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .supplier-dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    .supplier-dropdown-item.selected {
        background-color: #007bff;
        color: white;
    }
    
    .procurement-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }
    
    .procurement-info-text {
        font-size: 12px;
        color: #6c757d;
        margin-left: 24px;
        margin-top: -5px;
        margin-bottom: 10px;
    }
    
    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .radio-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
    }
    
    .radio-group input[type="radio"] {
        margin-right: 8px;
    }
    
    /* Stock level color coding */
    .stock-zero {
        color: #dc3545 !important;
        font-weight: bold;
    }
    
    .stock-low {
        color: #ffc107 !important;
        font-weight: bold;
    }
    
    .stock-good {
        color: #28a745 !important;
    }
    
    /* ABC class color coding */
    .abc-class-a {
        color: #dc3545 !important;
        font-weight: bold;
    }
    
    .abc-class-b {
        color: #ffc107 !important;
        font-weight: bold;
    }
    
    .abc-class-c {
        color: #6c757d !important;
    }
    
    /* Stock level percentage color coding */
    .stock-pct-critical {
        background: #ffcccc !important;
        color: #cc0000 !important;
        font-weight: bold;
    }
    
    .stock-pct-warning {
        background: #fff4cc !important;
        color: #996600 !important;
        font-weight: bold;
    }
    
    .stock-pct-good {
        background: #ccffcc !important;
        color: #006600 !important;
    }
    
    /* Table enhancements - Fixed alignment and sticky headers */
    .data-table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
    }
    
    /* Ensure table container has max height for scrolling */
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        position: relative;
    }
    
    /* Sticky header - works with proper table structure */
    .data-table thead {
        position: sticky;
        top: 0;
        z-index: 100;
        background: #f8f9fa;
    }
    
    .data-table th {
        position: sticky;
        top: 0;
        z-index: 100;
        user-select: none;
        background: #f8f9fa !important;
        border: 1px solid #dee2e6;
        padding: 10px 8px;
        text-align: left;
        font-weight: 600;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
    }
    
    .data-table td {
        border: 1px solid #dee2e6;
        padding: 8px;
        white-space: nowrap;
        vertical-align: middle;
    }
    
    .data-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    /* Visual distinction for stock columns */
    .data-table th:nth-child(4),
    .data-table td:nth-child(4) {
        background-color: #e3f2fd !important; /* HQ Stock column - light blue */
        border-left: 3px solid #2196F3;
        position: relative;
    }
    
    .data-table th:nth-child(4)::before {
        content: 'HQ';
        position: absolute;
        top: 2px;
        right: 4px;
        font-size: 9px;
        font-weight: bold;
        color: #1976D2;
        background: rgba(255, 255, 255, 0.7);
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    .data-table th:nth-child(6),
    .data-table td:nth-child(6) {
        background-color: #fff3e0 !important; /* Branch Stock column - light orange */
        border-left: 3px solid #ff9800;
        position: relative;
    }
    
    .data-table th:nth-child(6)::before {
        content: 'BRANCH';
        position: absolute;
        top: 2px;
        right: 4px;
        font-size: 9px;
        font-weight: bold;
        color: #F57C00;
        background: rgba(255, 255, 255, 0.7);
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    .data-table tbody tr:hover td:nth-child(4) {
        background-color: #bbdefb !important; /* Darker on hover for HQ Stock */
    }
    
    .data-table tbody tr:hover td:nth-child(6) {
        background-color: #ffe0b2 !important; /* Darker on hover for Branch Stock */
    }
    
    /* Order Qty column - fixed width */
    .data-table th:nth-child(10),
    .data-table td:nth-child(10) {
        width: 100px !important;
        min-width: 100px !important;
        max-width: 100px !important;
        text-align: center;
    }
    
    /* Order Qty input field - resized */
    .order-qty-input {
        width: 80px !important;
        min-width: 80px !important;
        max-width: 80px !important;
        padding: 4px 6px !important;
        font-size: 13px !important;
        text-align: center;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
    }
    
    .order-qty-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
    }
    
    /* Ensure proper alignment for all columns */
    .data-table th,
    .data-table td {
        box-sizing: border-box;
    }
    
    /* Center align checkbox column */
    .data-table th:first-child,
    .data-table td:first-child {
        text-align: center;
    }
    
    /* Center align numeric columns */
    .data-table th:nth-child(4),
    .data-table td:nth-child(4),
    .data-table th:nth-child(6),
    .data-table td:nth-child(6),
    .data-table th:nth-child(8),
    .data-table td:nth-child(8),
    .data-table th:nth-child(9),
    .data-table td:nth-child(9) {
        text-align: right;
        padding-right: 12px;
    }
    
    /* Center align ABC Class */
    .data-table th:nth-child(7),
    .data-table td:nth-child(7) {
        text-align: center;
    }
    
    .resizable-col {
        position: relative;
    }
    
    .resizable-col::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        cursor: col-resize;
        background: transparent;
    }
    
    .filter-icon {
        cursor: pointer;
        font-size: 10px;
        margin-left: 5px;
        opacity: 0.6;
    }
    
    .filter-icon:hover {
        opacity: 1;
    }
    
    .column-hidden {
        display: none;
    }
    
    /* Checkbox styling */
    .item-checkbox {
        cursor: pointer;
        width: 18px;
        height: 18px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Progress Modal -->
<div id="progressModal" class="progress-modal">
    <div class="progress-content">
        <div class="progress-header">
            <span id="progressIcon">üîÑ</span>
            <span>Refreshing Data</span>
            <button onclick="hideProgressModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; margin-left: auto; padding: 0 10px;" title="Close (refresh continues in background)">√ó</button>
        </div>
        <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
        </div>
        <div class="progress-message" id="progressMessage">Starting refresh...</div>
        <div class="progress-details" id="progressDetails"></div>
        <div class="progress-steps" id="progressSteps">
            <div class="progress-step pending" id="step1">üîÑ Connecting to Supabase database...</div>
            <div class="progress-step pending" id="step2">üì• Fetching stock data from APIs...</div>
            <div class="progress-step pending" id="step3">üíæ Saving data to Supabase...</div>
            <div class="progress-step pending" id="step4">üßπ Cleaning up old data...</div>
            <div class="progress-step pending" id="step5">‚úÖ Complete!</div>
        </div>
        <div class="progress-time" id="progressTime"></div>
    </div>
</div>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>üìä Dashboard</h1>
        <div>
            <div id="syncStatusInfo" style="font-size: 12px; color: #666; margin-top: 5px;">
                <span id="syncStatusText">Checking sync status...</span>
            </div>
        </div>
    </div>
    
    <!-- Credential Warning Banner -->
    <div id="credentialWarningBanner" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #856404;">
        <div id="credentialWarningText"></div>
    </div>
    
    <div class="refresh-section">
        <h3>Branch Selection</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group" style="margin-bottom: 0;">
                <label>Target Branch (View Stock For):</label>
                <select id="targetBranch" style="width: 100%; padding: 8px;">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Source Branch (Supply From):</label>
                <select id="sourceBranch" style="width: 100%; padding: 8px;">
                    <option value="">Loading...</option>
                </select>
            </div>
        </div>
        <div style="padding: 10px; background: #e3f2fd; border-radius: 5px; margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <div class="refresh-status" id="lastRefresh" style="font-size: 13px; color: #1976d2;">
                        Last refresh: Checking...
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Data auto-refreshes every hour. Current data is displayed below.
                    </div>
                </div>
                <button onclick="manualRefreshData()" class="btn btn-primary" id="manualRefreshBtn" style="padding: 10px 20px; font-size: 14px; white-space: nowrap;">
                    üîÑ Refresh Data Now
                </button>
            </div>
        </div>
    </div>
    
    <div class="section">
        <div class="section-header">
            <h2 class="section-title">‚ö†Ô∏è Priority Items</h2>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label>üîç Search:</label>
                    <input type="text" id="prioritySearch" placeholder="Search by item name or code..." 
                           style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 250px;"
                           onkeyup="filterPriorityTable()">
                </div>
                <div>
                    <label>Show items: </label>
                    <input type="number" id="priorityLimit" value="50" min="10" max="5000" style="width: 80px; padding: 5px;">
                </div>
                <button onclick="runProcurementBot('priority')" class="btn btn-success" id="priorityProcurementBtn" style="display: none;">
                    ü§ñ Order Selected Items
                </button>
            </div>
        </div>
        <div class="table-container" style="overflow-x: auto;">
            <table id="priorityTable" class="data-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="width: 40px; min-width: 40px; max-width: 40px;"><input type="checkbox" id="selectAllPriority" onchange="toggleAllItems('priority', this.checked)"></th>
                        <th style="width: 110px; min-width: 110px;" class="resizable-col" data-col="item_code">Item Code <span class="filter-icon" onclick="showFilter('priority', 'item_code', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 250px; min-width: 200px;" class="resizable-col" data-col="item_name">Item Name <span class="filter-icon" onclick="showFilter('priority', 'item_name', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 130px; min-width: 120px;" class="resizable-col" data-col="hq_stock">HQ Stock (Packs) <span class="filter-icon" onclick="showFilter('priority', 'hq_stock', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 150px; min-width: 120px;" class="resizable-col" data-col="branch">Branch <span class="filter-icon" onclick="showFilter('priority', 'branch', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 150px; min-width: 130px;" class="resizable-col" data-col="branch_stock">Branch Stock (Packs) <span class="filter-icon" onclick="showFilter('priority', 'branch_stock', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 90px; min-width: 90px;" class="resizable-col" data-col="abc_class">ABC Class <span class="filter-icon" onclick="showFilter('priority', 'abc_class', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 120px; min-width: 110px;" class="resizable-col" data-col="stock_level">Stock Level % <span class="filter-icon" onclick="showFilter('priority', 'stock_level', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 110px; min-width: 100px;" class="resizable-col" data-col="amc">AMC (Packs) <span class="filter-icon" onclick="showFilter('priority', 'amc', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 100px; min-width: 100px; max-width: 100px;" class="resizable-col" data-col="order_quantity">Order Qty (Packs) <span class="filter-icon" onclick="showFilter('priority', 'order_quantity', event)" style="cursor: pointer;">üîΩ</span></th>
                        <th style="width: 130px; min-width: 120px;" class="resizable-col" data-col="last_order_date">Last Order Date <span class="filter-icon" onclick="showFilter('priority', 'last_order_date', event)" style="cursor: pointer;">üîΩ</span></th>
                    </tr>
                </thead>
                <tbody id="priorityBody">
                    <tr>
                        <td colspan="10" class="loading">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Procurement Mode Selection Modal -->
<div id="procurementModal" class="procurement-modal">
    <div class="procurement-modal-content">
        <div class="procurement-modal-header">
            <h2>Select Procurement Mode</h2>
            <button class="close-procurement-modal" onclick="closeProcurementModal()">&times;</button>
        </div>
        
        <form id="procurementForm">
            <div class="procurement-form-group">
                <label>Order Type:</label>
                <div>
                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="radio" name="orderMode" value="purchase_order" checked onchange="toggleProcurementOptions()">
                        <span style="margin-left: 8px;">Purchase Order</span>
                    </label>
                    <div class="procurement-info-text">‚Ä¢ Orders from supplier</div>
                    
                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="radio" name="orderMode" value="branch_order" onchange="toggleProcurementOptions()">
                        <span style="margin-left: 8px;">Branch Order</span>
                    </label>
                    <div class="procurement-info-text">‚Ä¢ Orders from another branch (inter-branch transfer)</div>
                </div>
            </div>
            
            <!-- Supplier Selection (for Purchase Order) -->
            <div class="procurement-form-group" id="supplierSelectionGroup">
                <label for="supplierSearch">Supplier (Purchase Order):</label>
                <div class="supplier-search-container">
                    <input type="text" id="supplierSearch" placeholder="Search supplier by name or code..." 
                           autocomplete="off" oninput="searchSuppliers(this.value)" 
                           onfocus="showSupplierDropdown()" onblur="hideSupplierDropdown()">
                    <div id="supplierDropdown" class="supplier-dropdown"></div>
                </div>
                <input type="hidden" id="selectedSupplierCode" value="">
                <input type="hidden" id="selectedSupplierName" value="">
                <div id="selectedSupplierDisplay" style="margin-top: 8px; padding: 8px; background: #e9ecef; border-radius: 4px; display: none;">
                    <strong>Selected:</strong> <span id="selectedSupplierText"></span>
                </div>
            </div>
            
            <!-- Destination Branch Selection (for Branch Order) -->
            <div class="procurement-form-group" id="branchSelectionGroup" style="display: none;">
                <label for="destinationBranchSelect">Destination Branch (Branch Order):</label>
                <select id="destinationBranchSelect">
                    <option value="">-- Select Branch --</option>
                </select>
            </div>
            
            <!-- Credentials Section (Required for Accountability) -->
            <div class="procurement-form-group" style="border-top: 2px solid #dee2e6; padding-top: 15px; margin-top: 15px;">
                <label style="font-weight: bold; color: #dc3545;">üîê API Credentials (Required for Accountability)</label>
                <div class="procurement-info-text" style="margin-bottom: 10px; color: #6c757d;">
                    Please provide current API credentials. These will be used for this order only and are not saved.
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label for="procurementCompany">Company:</label>
                    <select id="procurementCompany" required style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <option value="">-- Select Company --</option>
                        <option value="NILA">NILA</option>
                        <option value="DAIMA">DAIMA</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label for="procurementUsername">Username:</label>
                    <input type="text" id="procurementUsername" required 
                           placeholder="Enter API username" 
                           style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label for="procurementPassword">Password:</label>
                    <input type="password" id="procurementPassword" required 
                           placeholder="Enter API password" 
                           style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                </div>
            </div>
            
            <div class="procurement-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProcurementModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmProcurementOrder()">Create Order</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Ensure apiRequest is available (from base.html, but add fallback if needed)
    // Define globally to ensure it's accessible everywhere
    if (typeof apiRequest === 'undefined') {
        console.warn('‚ö†Ô∏è apiRequest not found in base.html, defining fallback...');
        window.apiRequest = async function apiRequest(url, options = {}) {
            const token = localStorage.getItem('access_token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            // Add timeout to prevent hanging
            const controller = new AbortController();
            const isLargeQuery = url.includes('/stock/data') || url.includes('/dashboard/priority-items') || url.includes('/dashboard/new-arrivals');
            const isStockView = url.includes('/stock/data');
            const timeout = isStockView ? 300000 : (isLargeQuery ? 120000 : 30000);
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Handle authentication errors
                if (response.status === 401 || response.status === 403) {
                    console.warn('Authentication error:', response.status, url);
                    const errorData = await response.json().catch(() => ({ detail: 'Authentication required' }));
                    if (window.location.pathname.includes('/admin')) {
                        throw new Error(errorData.detail || `Authentication error: ${response.status}`);
                    }
                    if (token) {
                        // logout function should be in base.html
                        if (typeof logout === 'function') {
                            logout();
                        } else {
                            window.location.href = '/';
                        }
                    }
                    return null;
                }
                
                // Handle other errors
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('API error:', response.status, errorData);
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.error('Request timeout:', url);
                    throw new Error('Request timed out. Please try again.');
                }
                throw error;
            }
        };
    }
    
    // Ensure apiRequest is globally accessible
    if (typeof apiRequest !== 'undefined' && typeof window.apiRequest === 'undefined') {
        window.apiRequest = apiRequest;
    }
    
    let refreshInProgress = false;
    
    // Date formatting function
    function formatDate(dateString) {
        if (!dateString || dateString === 'Never' || dateString === null || dateString === '') {
            return 'Never';
        }
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return 'Invalid Date';
            }
            
            // Format as "dd mmm, yy" (e.g., "15 Dec, 24")
            const day = date.getDate();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2);
            
            return `${day} ${month}, ${year}`;
        } catch (e) {
            return 'Invalid Date';
        }
    }
    
    // Global error handler for uncaught JS errors
    window.addEventListener('error', (event) => {
        console.error('Uncaught JavaScript error:', event.error);
        console.error('Error details:', {
            message: event.message,
            filename: event.filename,
            lineno: event.lineno,
            colno: event.colno
        });
        // Don't break execution - log and continue
        return true;
    });
    
    // Global promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        // Don't break execution - log and continue
        event.preventDefault();
    });
    
    // Check authentication first
    window.addEventListener('DOMContentLoaded', () => {
        try {
            const token = localStorage.getItem('access_token');
            
            // Redirect to login if not authenticated
            if (!token) {
                window.location.href = '/';
                return;
            }
            
            // Show loading state immediately
            // Initialize tables
            const priorityItemsTable = document.getElementById('priorityTable');
            if (priorityItemsTable) {
                const tbody = priorityItemsTable.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Loading...</td></tr>';
                }
            }
            
            // Load branches first - this will trigger loadPriorityItems when done
            console.log('üìã Calling loadBranches()...');
            loadBranches().catch(error => {
                console.error('‚ùå Error in loadBranches():', error);
                // Show error in dropdowns
                const targetSelect = document.getElementById('targetBranch');
                const sourceSelect = document.getElementById('sourceBranch');
                if (targetSelect) targetSelect.innerHTML = '<option value="">Error loading branches</option>';
                if (sourceSelect) sourceSelect.innerHTML = '<option value="">Error loading branches</option>';
            });
        } catch (e) {
            console.error('‚ùå Error in DOMContentLoaded handler:', e);
        }
        
        // Check refresh status once on page load - ONLY to show existing refresh progress
        // This does NOT trigger a new refresh - it only checks if one is already running
        // Refresh should ONLY be triggered by:
        // 1. User clicking "Refresh Data Now" button (manualRefreshData)
        // 2. Scheduled refresh (scheduler)
        checkRefreshStatus();
        
        // Note: Event listeners for branch changes are added in loadBranches()
        // to avoid duplicates and ensure branches are loaded first
        
        // Initialize priority limit change handler
        const priorityLimitInput = document.getElementById('priorityLimit');
        if (priorityLimitInput) {
            priorityLimitInput.addEventListener('change', loadPriorityItems);
        }
        
        // Initialize search handler
        const prioritySearch = document.getElementById('prioritySearch');
        if (prioritySearch) {
            prioritySearch.addEventListener('keyup', filterPriorityTable);
        }
    });
    
    async function loadDashboardData() {
        // Try to load cached priority items first (for persistence across tabs)
        try {
            const targetBranch = document.getElementById('targetBranch')?.value || 'BABA DOGO HQ|NILA';
            const sourceBranch = document.getElementById('sourceBranch')?.value || 'BABA DOGO HQ|NILA';
            const [targetBranchName] = targetBranch.split('|');
            const [sourceBranchName] = sourceBranch.split('|');
            const storageKey = `priorityItems_${targetBranchName}_${sourceBranchName}`;
            const cached = localStorage.getItem(storageKey);
            
            if (cached) {
                const cachedData = JSON.parse(cached);
                // Use cached data if less than 5 minutes old
                if (Date.now() - cachedData.timestamp < 5 * 60 * 1000) {
                    console.log('Loading cached priority items');
                    window.priorityItemsData = cachedData.data;
                    displayPriorityItems(cachedData.data);
                }
            }
        } catch (e) {
            console.warn('Could not load cached priority items:', e);
        }
        
        // Load fresh data from database
        await loadPriorityItems();
        
        // Note: Don't check refresh status here - it's already checked on page load
        // Refresh should ONLY be triggered by:
        // 1. User clicking "Refresh Data Now" button
        // 2. Scheduled refresh (scheduler)
    }
    
    function displayPriorityItems(items) {
        const tbody = document.getElementById('priorityBody');
        if (!tbody || !items || items.length === 0) return;
        
        tbody.innerHTML = '';
        items.forEach((item, index) => {
            const row = tbody.insertRow();
            
            // Column 0: Checkbox
            const checkboxCell = row.insertCell(0);
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'item-checkbox';
            checkbox.dataset.index = index;
            checkboxCell.appendChild(checkbox);
            
            // Column 1: Item Code
            row.insertCell(1).textContent = item.item_code || '';
            
            // Column 2: Item Name
            row.insertCell(2).textContent = item.item_name || '';
            
            // Column 3: HQ Stock (Packs)
            const hqStock = parseFloat(item.source_stock_packs || item.hq_stock_packs || 0);
            const hqCell = row.insertCell(3);
            hqCell.textContent = hqStock.toFixed(0);
            if (hqStock === 0) {
                hqCell.classList.add('stock-zero');
            } else if (hqStock < 10) {
                hqCell.classList.add('stock-low');
            } else {
                hqCell.classList.add('stock-good');
            }
            
            // Column 4: Branch
            row.insertCell(4).textContent = item.branch_name || item.target_branch || '';
            
            // Column 5: Branch Stock (Packs)
            const branchStock = parseFloat(item.target_stock_packs || item.branch_stock_packs || 0);
            const branchStockCell = row.insertCell(5);
            branchStockCell.textContent = branchStock.toFixed(0);
            if (branchStock === 0) {
                branchStockCell.classList.add('stock-zero');
            } else if (branchStock < 10) {
                branchStockCell.classList.add('stock-low');
            } else {
                branchStockCell.classList.add('stock-good');
            }
            
            // Column 6: ABC Class
            const abcClass = (item.abc_class || '').trim().toUpperCase();
            const abcCell = row.insertCell(6);
            abcCell.textContent = abcClass;
            if (abcClass === 'A') {
                abcCell.classList.add('abc-class-a');
            } else if (abcClass === 'B') {
                abcCell.classList.add('abc-class-b');
            } else if (abcClass === 'C') {
                abcCell.classList.add('abc-class-c');
            }
            
            // Column 7: Stock Level %
            const stockLevel = parseFloat(item.stock_level_pct || 0);
            const stockLevelCell = row.insertCell(7);
            stockLevelCell.textContent = stockLevel.toFixed(1) + '%';
            if (stockLevel < 20) {
                stockLevelCell.classList.add('stock-pct-critical');
            } else if (stockLevel < 30) {
                stockLevelCell.classList.add('stock-pct-warning');
            } else {
                stockLevelCell.classList.add('stock-pct-good');
            }
            
            // Column 8: AMC (Packs)
            const amcPacks = parseFloat(item.amc_packs || 0);
            row.insertCell(8).textContent = amcPacks.toFixed(1);
            
            // Column 9: Order Qty (Packs) - editable
            const orderQtyCell = row.insertCell(9);
            const orderQtyInput = document.createElement('input');
            orderQtyInput.type = 'number';
            orderQtyInput.min = '0';
            orderQtyInput.step = '1';
            orderQtyInput.value = item.custom_order_quantity || '';
            orderQtyInput.className = 'order-qty-input';
            orderQtyInput.dataset.index = index;
            orderQtyInput.addEventListener('change', function() {
                updateOrderQuantity('priority', index, parseFloat(this.value) || 0);
            });
            orderQtyCell.appendChild(orderQtyInput);
            
            // Column 10: Last Order Date
            row.insertCell(10).textContent = item.last_order_date || '';
        });
        
        // Show procurement button
        const btn = document.getElementById('priorityProcurementBtn');
        if (btn) btn.style.display = 'inline-block';
    }
    
    async function loadBranches() {
        console.log('üîÑ loadBranches() called');
        const targetSelect = document.getElementById('targetBranch');
        const sourceSelect = document.getElementById('sourceBranch');
        
        if (!targetSelect || !sourceSelect) {
            console.error('‚ùå Branch select elements not found!');
            return;
        }
        
        // Show loading state
        targetSelect.innerHTML = '<option value="">Loading...</option>';
        sourceSelect.innerHTML = '<option value="">Loading...</option>';
        
        try {
            console.log('üì° Loading branches from /api/dashboard/branches...');
            const token = localStorage.getItem('access_token');
            if (!token) {
                console.error('‚ùå No access token found!');
                targetSelect.innerHTML = '<option value="">Please login</option>';
                sourceSelect.innerHTML = '<option value="">Please login</option>';
                return;
            }
            
            const data = await apiRequest('/api/dashboard/branches');
            console.log('‚úÖ Branches API response:', data);
            
            if (!data) {
                console.error('‚ùå No data returned from branches API');
                targetSelect.innerHTML = '<option value="">Error loading branches</option>';
                sourceSelect.innerHTML = '<option value="">Error loading branches</option>';
                return;
            }
            
            if (data.success && data.data && Array.isArray(data.data) && data.data.length > 0) {
                console.log(`‚úÖ Found ${data.data.length} branches from API`);
                console.log('üìã Branch data:', data.data);
                
                // Clear and populate both selects - ensure ALL branches are added
                [targetSelect, sourceSelect].forEach(select => {
                    select.innerHTML = '<option value="">Select branch...</option>';
                    let addedCount = 0;
                    data.data.forEach((branch, index) => {
                        const option = document.createElement('option');
                        const branchName = branch.branch_name || branch.branch || 'Unknown';
                        const branchCompany = branch.company || 'Unknown';
                        // Store both branch and company in value for queries, but display only branch name
                        const value = `${branchName}|${branchCompany}`;
                        option.value = value;
                        option.textContent = branchName; // Display only branch name, no company in brackets
                        select.appendChild(option);
                        addedCount++;
                    });
                    console.log(`‚úÖ Added ${addedCount} branches to ${select.id} dropdown (total options: ${select.options.length})`);
                });
                
                // Set defaults - Source should be HQ (BABA DOGO HQ), Target should be a different branch
                // Priority items show items available at source that are needed at target
                const hqBranchName = 'BABA DOGO HQ';
                const hqOption = Array.from(sourceSelect.options).find(opt => {
                    const [branchName] = opt.value.split('|');
                    return branchName === hqBranchName;
                });
                
                // Set source to HQ (where stock is available)
                if (hqOption) {
                    sourceSelect.value = hqOption.value;
                    console.log('‚úÖ Set source branch (HQ):', hqOption.value);
                } else if (sourceSelect.options.length > 1) {
                    sourceSelect.value = sourceSelect.options[1].value;
                    console.log('‚úÖ Set first branch as source:', sourceSelect.options[1].value);
                }
                
                // Set target to a different branch (preferably retail, not HQ)
                // Find a branch that's NOT the same as source
                const sourceValue = sourceSelect.value;
                const targetOption = Array.from(targetSelect.options).find(opt => {
                    return opt.value && opt.value !== sourceValue && opt.value !== '';
                });
                
                if (targetOption) {
                    targetSelect.value = targetOption.value;
                    console.log('‚úÖ Set target branch (different from source):', targetOption.value);
                } else {
                    // If no different branch found, use source (will show warning message)
                    targetSelect.value = sourceValue;
                    console.log('‚ö†Ô∏è No different branch found, using same as source (priority items will be empty)');
                }
                
                // Add change event listeners to reload priority items when branches change
                // Use once: true to prevent duplicate listeners, or remove and re-add
                const savedTargetValue = targetSelect.value;
                const savedSourceValue = sourceSelect.value;
                
                // Remove old listeners by cloning
                const newTargetSelect = targetSelect.cloneNode(true);
                const newSourceSelect = sourceSelect.cloneNode(true);
                newTargetSelect.value = savedTargetValue;
                newSourceSelect.value = savedSourceValue;
                targetSelect.parentNode.replaceChild(newTargetSelect, targetSelect);
                sourceSelect.parentNode.replaceChild(newSourceSelect, sourceSelect);
                
                // Add new event listeners
                newTargetSelect.addEventListener('change', () => {
                    console.log('Target branch changed, reloading priority items...');
                    loadPriorityItems();
                });
                newSourceSelect.addEventListener('change', () => {
                    console.log('Source branch changed, reloading priority items...');
                    loadPriorityItems();
                });
                
                // Trigger loadPriorityItems after branches are loaded
                console.log('‚úÖ Branches loaded successfully, triggering loadPriorityItems...');
                setTimeout(() => {
                    try {
                        loadPriorityItems();
                    } catch (error) {
                        console.error('Error loading priority items:', error);
                    }
                }, 100);
                
                console.log('‚úÖ Branches loaded successfully');
            } else {
                // Error loading branches - try fallback
                const errorMsg = data && data.error ? data.error : (data?.message || 'No branches found');
                console.error('Failed to load branches:', errorMsg, data);
                if (targetSelect) targetSelect.innerHTML = `<option value="">Error: ${errorMsg}</option>`;
                if (sourceSelect) sourceSelect.innerHTML = `<option value="">Error: ${errorMsg}</option>`;
                
                // Try fallback: hardcoded branches
                console.log('Attempting fallback with hardcoded branches...');
                const fallbackBranches = [
                    { branch_name: 'BABA DOGO HQ', company: 'NILA' },
                    { branch_name: 'DAIMA MERU WHOLESALE', company: 'DAIMA' },
                    { branch_name: 'DAIMA MERU RETAIL', company: 'DAIMA' }
                ];
                [targetSelect, sourceSelect].forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">Select branch...</option>';
                        fallbackBranches.forEach(branch => {
                            const option = document.createElement('option');
                            const value = `${branch.branch_name}|${branch.company}`;
                            option.value = value;
                            option.textContent = branch.branch_name;
                            select.appendChild(option);
                        });
                    }
                });
                if (targetSelect && targetSelect.options.length > 1) {
                    targetSelect.selectedIndex = 1;
                }
                if (sourceSelect && sourceSelect.options.length > 1) {
                    sourceSelect.selectedIndex = 1;
                }
                
                if (data?.message && data.message.includes('empty')) {
                    console.log('üí° Tip: Database is empty. Click "Refresh Data Now" to load branches.');
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading branches:', error);
            console.error('Error stack:', error.stack);
            const errorMsg = error.message || 'Failed to load';
            if (targetSelect) targetSelect.innerHTML = `<option value="">Error: ${errorMsg}</option>`;
            if (sourceSelect) sourceSelect.innerHTML = `<option value="">Error: ${errorMsg}</option>`;
            
            // Try fallback on error too
            console.log('Attempting fallback with hardcoded branches after error...');
            const fallbackBranches = [
                { branch_name: 'BABA DOGO HQ', company: 'NILA' },
                { branch_name: 'DAIMA MERU WHOLESALE', company: 'DAIMA' },
                { branch_name: 'DAIMA MERU RETAIL', company: 'DAIMA' }
            ];
            [targetSelect, sourceSelect].forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Select branch...</option>';
                    fallbackBranches.forEach(branch => {
                        const option = document.createElement('option');
                        const value = `${branch.branch_name}|${branch.company}`;
                        option.value = value;
                        option.textContent = branch.branch_name;
                        select.appendChild(option);
                    });
                }
            });
            if (targetSelect && targetSelect.options.length > 1) {
                targetSelect.selectedIndex = 1;
            }
            if (sourceSelect && sourceSelect.options.length > 1) {
                sourceSelect.selectedIndex = 1;
            }
        }
    }
    
    // Make manualRefreshData globally accessible
    window.manualRefreshData = async function manualRefreshData() {
        const btn = document.getElementById('manualRefreshBtn');
        if (!btn) {
            console.error('Refresh button not found');
            return;
        }
        
        const originalText = btn.innerHTML;
        
        // Disable button and show loading
        btn.disabled = true;
        btn.innerHTML = 'üîÑ Refreshing...';
        
        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please login first');
                window.location.href = '/';
                return;
            }
            
            // Show progress modal
            showProgressModal();
            updateProgress(0, 'Starting data refresh...', 'Connecting to APIs and fetching latest data');
            
            // Call refresh trigger API - uses saved credentials from database
            console.log('üì° Calling /api/refresh/trigger...');
            const response = await fetch('/api/refresh/trigger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({})
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('‚úÖ Refresh trigger response:', data);
            
            if (data.status === 'started' || data.success) {
                updateProgress(10, '‚úÖ Refresh started!', 'Fetching data from APIs. This may take 10-30 minutes.');
                
                // Start polling for progress
                startProgressPolling();
                
                // Show success message
                setTimeout(() => {
                    alert('‚úÖ Data refresh started! The progress modal will show updates. Current data remains visible.');
                }, 1000);
            } else {
                const errorMsg = data.message || data.detail || 'Unknown error';
                console.error('‚ùå Refresh failed:', errorMsg);
                updateProgress(0, '‚ùå Refresh failed', errorMsg);
                setTimeout(() => {
                    hideProgressModal();
                    alert('‚ùå Refresh failed: ' + errorMsg);
                }, 3000);
            }
        } catch (error) {
            console.error('‚ùå Error refreshing data:', error);
            updateProgress(0, '‚ùå Error', 'Failed to refresh data: ' + error.message);
            setTimeout(() => {
                hideProgressModal();
                alert('‚ùå Error refreshing data: ' + error.message);
            }, 3000);
        } finally {
            // Re-enable button after a delay
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }, 2000);
        }
    };
    
    async function loadPriorityItems() {
        // Check token before making request
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/';
            return;
        }
        
        // Show loading indicator
        const tbody = document.getElementById('priorityBody');
        if (!tbody) {
            console.error('Priority table body not found');
            return;
        }
        tbody.innerHTML = '<tr><td colspan="11" class="empty">Loading...</td></tr>';
        
        // Get selected branches
        const targetBranch = document.getElementById('targetBranch')?.value;
        const sourceBranch = document.getElementById('sourceBranch')?.value;
        
        if (!targetBranch || !sourceBranch) {
            tbody.innerHTML = '<tr><td colspan="11" class="empty">Please select both target and source branches</td></tr>';
            return;
        }
        
        const [targetBranchName, targetCompany] = targetBranch.split('|');
        const [sourceBranchName, sourceCompany] = sourceBranch.split('|');
        const limit = parseInt(document.getElementById('priorityLimit')?.value || '50');
        
        try {
            console.log(`üì° Loading priority items: target=${targetBranchName} (${targetCompany}), source=${sourceBranchName} (${sourceCompany}), limit=${limit}`);
            const apiUrl = `/api/dashboard/priority-items?target_branch=${encodeURIComponent(targetBranchName)}&target_company=${encodeURIComponent(targetCompany)}&source_branch=${encodeURIComponent(sourceBranchName)}&source_company=${encodeURIComponent(sourceCompany)}&limit=${limit}`;
            console.log('API URL:', apiUrl);
            
            const data = await apiRequest(apiUrl);
            
            if (!data) {
                console.error('‚ùå No data returned from priority items API');
                tbody.innerHTML = '<tr><td colspan="11" class="empty">Error loading priority items. Please try again.</td></tr>';
                return;
            }
            
            // Clear existing content
            tbody.innerHTML = '';
            
            // Log response for debugging
            console.log('Priority items API response:', data);
            
            // Handle error cases first
            if (!data.success) {
                const errorMsg = data.error || data.message || 'Unknown error';
                console.error('‚ùå Priority items API error:', errorMsg);
                tbody.innerHTML = `<tr><td colspan="11" class="empty">Error: ${errorMsg}</td></tr>`;
                return;
            }
            
            // Handle both error and empty data cases
            if (data.count === 0 && (!data.data || data.data.length === 0)) {
                const isRefreshing = data.is_refreshing || false;
                let message = data.message || (data.error || 'No data available');
                
                // Check if source and target are the same
                if (targetBranchName === sourceBranchName && targetCompany === sourceCompany) {
                    message = `‚ö†Ô∏è Source and target branches are the same (${sourceBranchName}). Priority items show items available at the source branch that are needed at a different target branch. Please select different branches.`;
                }
                
                // Show helpful message
                if (isRefreshing) {
                    // Refresh in progress - show encouraging message
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" class="empty" style="padding: 40px; text-align: center;">
                                <div style="font-size: 20px; margin-bottom: 15px;">üîÑ Data Refresh In Progress</div>
                                <div style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                                    <p>Your data is being fetched from APIs. This may take 10-30 minutes.</p>
                                    <p style="margin-top: 10px; font-size: 14px; color: #999;">
                                        <strong>You can:</strong><br>
                                        ‚Ä¢ Keep this page open - data will appear automatically when ready<br>
                                        ‚Ä¢ Check the progress modal for detailed status<br>
                                        ‚Ä¢ The page will auto-refresh every 30 seconds
                                    </p>
                                </div>
                                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; color: #1976d2;">
                                    <strong>üí° Tip:</strong> On future visits, cached data will load instantly!
                                </div>
                            </td>
                        </tr>
                    `;
                    // Auto-refresh every 30 seconds while refreshing
                    setTimeout(() => {
                        if (document.getElementById('progressModal') && document.getElementById('progressModal').classList.contains('show')) {
                            loadPriorityItems();
                        }
                    }, 30000);
                } else {
                    // No refresh in progress - show refresh button
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" class="empty" style="padding: 40px; text-align: center;">
                                <div style="font-size: 18px; margin-bottom: 15px;">üìä No Data Available</div>
                                <div style="color: #666; margin-bottom: 20px;">
                                    ${message}
                                </div>
                                <div style="margin-top: 15px; font-size: 12px; color: #999;">
                                    Data refreshes automatically every hour. Please wait for the next scheduled refresh.
                                </div>
                            </td>
                        </tr>
                    `;
                }
                return;
            }
            
            if (data.success && data.data && data.data.length > 0) {
                // Store items for procurement bot
                window.priorityItemsData = data.data;
                
                // Save to localStorage for persistence across tabs
                try {
                    const storageKey = `priorityItems_${targetBranchName}_${sourceBranchName}`;
                    localStorage.setItem(storageKey, JSON.stringify({
                        data: data.data,
                        timestamp: Date.now(),
                        targetBranch: targetBranchName,
                        sourceBranch: sourceBranchName
                    }));
                } catch (e) {
                    console.warn('Could not save priority items to localStorage:', e);
                }
                
                // Show procurement button
                const btn = document.getElementById('priorityProcurementBtn');
                if (btn) btn.style.display = 'inline-block';
                
                // Use the display function to render items
                displayPriorityItems(data.data);
                
                // Restore selected items and order quantities from saved state
                setTimeout(() => {
                    try {
                        const stateStr = localStorage.getItem('priorityTableState');
                        if (stateStr) {
                            const state = JSON.parse(stateStr);
                            
                            // Restore checkboxes
                            if (state.selectedItems) {
                                state.selectedItems.forEach(index => {
                                    const checkbox = document.querySelector(`#priorityBody input[type="checkbox"][data-index="${index}"]`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            }
                            
                            // Restore order quantities
                            if (state.orderQuantities) {
                                Object.entries(state.orderQuantities).forEach(([index, value]) => {
                                    const input = document.querySelector(`#priorityBody input.order-qty-input[data-index="${index}"]`);
                                    if (input) input.value = value;
                                });
                            }
                            
                            // Restore scroll position
                            const container = document.querySelector('.table-container');
                            if (container && state.scrollPosition) {
                                container.scrollTop = state.scrollPosition;
                            }
                            
                            // Apply search filter if exists
                            if (state.searchTerm && document.getElementById('prioritySearch')) {
                                document.getElementById('prioritySearch').value = state.searchTerm;
                                filterPriorityTable();
                            }
                        }
                    } catch (e) {
                        console.warn('Could not restore priority state:', e);
                    }
                }, 100);
                
                // Log for debugging
                console.log(`‚úÖ Displayed ${data.data.length} priority items`);
            } else {
                tbody.innerHTML = '<tr><td colspan="11" class="empty">No priority items found</td></tr>';
                const btn = document.getElementById('priorityProcurementBtn');
                if (btn) btn.style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading priority items:', error);
            const tbody = document.getElementById('priorityBody');
            if (tbody) {
                let errorMsg = 'Unknown error';
                if (error.name === 'AbortError') {
                    errorMsg = 'Request timed out. The database is large and may take time to query. Please try again.';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                // Check if data exists (might be undefined if request failed)
                if (typeof data !== 'undefined' && data && data.error) {
                    errorMsg = data.error;
                    if (data.traceback) {
                        console.error('Traceback:', data.traceback);
                    }
                }
                tbody.innerHTML = 
                    '<tr><td colspan="11" class="empty">Error loading data: ' + errorMsg + '</td></tr>';
            }
        }
    }
    
    async function triggerRefresh() {
        if (refreshInProgress) {
            alert('Refresh already in progress');
            return;
        }
        
        // Check if credentials are already saved
        let useSavedCredentials = false;
        try {
            const credStatus = await apiRequest('/api/credentials/status');
            if (credStatus.success && credStatus.credentials) {
                const nilaConfigured = credStatus.credentials.NILA?.configured;
                const daimaConfigured = credStatus.credentials.DAIMA?.configured;
                
                if (nilaConfigured || daimaConfigured) {
                    // Auto-use saved credentials, but allow user to override
                    useSavedCredentials = true;
                }
            }
        } catch (e) {
            console.error('Error checking credentials:', e);
        }
        
        let nilaUsername = null;
        let nilaPassword = null;
        let daimaUsername = null;
        let daimaPassword = null;
        
        // If saved credentials exist, use them automatically (no prompt)
        // User can still configure new credentials in Settings if needed
        if (!useSavedCredentials) {
            // Only prompt if no saved credentials exist
            nilaUsername = prompt('Enter NILA username (or leave empty):');
            nilaPassword = nilaUsername ? prompt('Enter NILA password:') : null;
            
            daimaUsername = prompt('Enter DAIMA username (or leave empty):');
            daimaPassword = daimaUsername ? prompt('Enter DAIMA password:') : null;
            
            // If nothing provided and no saved credentials, show error
            if (!nilaUsername && !daimaUsername) {
                try {
                    const credStatus = await apiRequest('/api/credentials/status');
                    if (credStatus.success && credStatus.credentials) {
                        const nilaConfigured = credStatus.credentials.NILA?.configured;
                        const daimaConfigured = credStatus.credentials.DAIMA?.configured;
                        if (!nilaConfigured && !daimaConfigured) {
                            alert('Please provide credentials for at least one company or configure them in Settings first.');
                            return;
                        }
                    }
                } catch (e) {
                    alert('Please provide credentials for at least one company');
                    return;
                }
            }
        }
        
        refreshInProgress = true;
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshStatus = document.getElementById('refreshStatus');
        
        refreshBtn.disabled = true;
        refreshStatus.textContent = 'üîÑ Refreshing data...';
        
        // Show progress modal
        showProgressModal();
        
        try {
            const result = await apiRequest('/api/refresh/all', {
                method: 'POST',
                body: JSON.stringify({
                    nila_username: nilaUsername || null,
                    nila_password: nilaPassword || null,
                    daima_username: daimaUsername || null,
                    daima_password: daimaPassword || null
                })
            });
            
            if (result && result.status === 'started') {
                refreshStatus.textContent = '‚úÖ Refresh started in background. Current data is still visible.';
                // Show progress modal but don't block UI - data is already displayed
                showProgressModal();
                // Start polling for progress
                startProgressPolling();
                // Continue showing existing data while refresh happens
                // Data will auto-update when refresh completes
            } else {
                refreshStatus.textContent = '‚ùå Refresh failed';
                hideProgressModal();
            }
        } catch (error) {
            console.error('Refresh error:', error);
            refreshStatus.textContent = '‚ùå Error triggering refresh';
            hideProgressModal();
            alert('Failed to start refresh: ' + (error.message || 'Unknown error'));
        } finally {
            refreshBtn.disabled = false;
            refreshInProgress = false;
        }
    }
    
    // Progress Modal Functions
    function showProgressModal() {
        const modal = document.getElementById('progressModal');
        if (modal) {
            modal.classList.add('show');
            updateProgressBar(0, 'Starting refresh...');
            resetProgressSteps();
        }
    }
    
    function hideProgressModal() {
        const modal = document.getElementById('progressModal');
        if (modal) {
            modal.classList.remove('show');
        }
    }
    
    function updateProgress(percent, message, details) {
        // Wrapper function for updateProgressBar that also handles details
        updateProgressBar(percent, message);
        if (details) {
            const progressDetails = document.getElementById('progressDetails');
            if (progressDetails) {
                progressDetails.textContent = details;
            }
        }
    }
    
    function updateProgressBar(percent, message) {
        const progressBar = document.getElementById('progressBar');
        const progressMessage = document.getElementById('progressMessage');
        const progressIcon = document.getElementById('progressIcon');
        
        if (progressBar) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
        }
        
        if (progressMessage) {
            progressMessage.textContent = message || '';
        }
        
        // Update icon based on progress
        if (progressIcon) {
            if (percent >= 90) {
                progressIcon.textContent = 'üì§';
            } else if (percent >= 50) {
                progressIcon.textContent = 'üîÑ';
            } else if (percent >= 10) {
                progressIcon.textContent = 'üì•';
            } else {
                progressIcon.textContent = 'üîÑ';
            }
        }
    }
    
    function resetProgressSteps() {
        const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
        steps.forEach(stepId => {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = 'progress-step pending';
            }
        });
    }
    
    function updateProgressStep(stepNumber, status) {
        const step = document.getElementById('step' + stepNumber);
        if (step) {
            step.className = 'progress-step ' + status;
        }
    }
    
    let progressPollingInterval = null;
    
    function startProgressPolling() {
        // Clear any existing polling
        if (progressPollingInterval) {
            clearInterval(progressPollingInterval);
        }
        
        let startTime = Date.now();
        const progressTimeEl = document.getElementById('progressTime');
        
        // Update time elapsed
        const timeInterval = setInterval(() => {
            if (progressTimeEl) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                progressTimeEl.textContent = `Elapsed time: ${minutes}m ${seconds}s`;
            }
        }, 1000);
        
        // Poll for progress
        progressPollingInterval = setInterval(async () => {
            try {
                const status = await apiRequest('/api/refresh/status');
                
                const isRefreshing = status.is_refreshing || false;
                const progress = status.refresh_progress || 0;
                const message = status.refresh_message || 'Processing...';
                const lastRefresh = status.last_refresh;
                
                // Update progress bar
                updateProgressBar(progress * 100, message);
                
                // Update progress steps based on progress
                if (progress < 0.1) {
                    updateProgressStep(1, 'active');
                } else if (progress < 0.3) {
                    updateProgressStep(1, 'completed');
                    updateProgressStep(2, 'active');
                } else if (progress < 0.7) {
                    updateProgressStep(1, 'completed');
                    updateProgressStep(2, 'completed');
                    updateProgressStep(3, 'active');
                } else if (progress < 0.9) {
                    updateProgressStep(1, 'completed');
                    updateProgressStep(2, 'completed');
                    updateProgressStep(3, 'completed');
                    updateProgressStep(4, 'active');
                } else if (progress >= 0.9) {
                    updateProgressStep(1, 'completed');
                    updateProgressStep(2, 'completed');
                    updateProgressStep(3, 'completed');
                    updateProgressStep(4, 'completed');
                    updateProgressStep(5, 'active');
                }
                
                // Update details
                const progressDetails = document.getElementById('progressDetails');
                if (progressDetails) {
                    if (progress < 0.1) {
                        progressDetails.textContent = 'Connecting to Supabase database...';
                    } else if (progress < 0.3) {
                        progressDetails.textContent = 'Fetching stock, orders, and sales data from APIs...';
                    } else if (progress < 0.7) {
                        progressDetails.textContent = 'Saving data to Supabase database...';
                    } else if (progress < 0.9) {
                        progressDetails.textContent = 'Cleaning up old data (30-day retention)...';
                    } else {
                        progressDetails.textContent = 'Finalizing...';
                    }
                }
                
                // If refresh is complete
                if (!isRefreshing && lastRefresh) {
                    clearInterval(progressPollingInterval);
                    clearInterval(timeInterval);
                    progressPollingInterval = null;
                    
                    updateProgressBar(100, 'Refresh complete!');
                    updateProgressStep(5, 'completed');
                    
                    // Update UI - reload data silently (no blocking alert)
                    setTimeout(() => {
                        hideProgressModal();
                        loadPriorityItems(); // Reload priority items to show updated data
                        // Update last refresh time directly (don't call checkRefreshStatus to avoid triggering anything)
                        const lastRefreshEl = document.getElementById('lastRefresh');
                        if (lastRefreshEl && lastRefresh) {
                            lastRefreshEl.textContent = `Last refresh: ${new Date(lastRefresh).toLocaleString()}`;
                        }
                        // Show subtle notification instead of blocking alert
                        const refreshStatus = document.getElementById('refreshStatus');
                        if (refreshStatus) {
                            refreshStatus.textContent = '‚úÖ Data refreshed! Dashboard updated.';
                            setTimeout(() => {
                                refreshStatus.textContent = '';
                            }, 5000);
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error polling refresh status:', error);
            }
        }, 2000); // Poll every 2 seconds
    }
    
    async function checkRefreshStatus() {
        // IMPORTANT: This function ONLY checks status - it does NOT trigger a refresh
        // Refresh is ONLY triggered by:
        // 1. User clicking "Refresh Data Now" button (manualRefreshData function)
        // 2. Scheduled refresh (scheduler in main.py)
        try {
            const status = await apiRequest('/api/refresh/status');
            if (status) {
                const lastRefreshEl = document.getElementById('lastRefresh');
                if (lastRefreshEl && status.last_refresh) {
                    lastRefreshEl.textContent = `Last refresh: ${new Date(status.last_refresh).toLocaleString()}`;
                }
                
                // If refresh is in progress, show modal and start polling
                // This only happens if a refresh was already started (by button click or scheduler)
                if (status.is_refreshing) {
                    console.log('üìä Refresh is already in progress - showing progress modal');
                    const modal = document.getElementById('progressModal');
                    if (modal && !modal.classList.contains('show')) {
                        showProgressModal();
                        startProgressPolling();
                    }
                } else {
                    // Refresh is not in progress - make sure modal is hidden
                    const modal = document.getElementById('progressModal');
                    if (modal && modal.classList.contains('show')) {
                        console.log('üìä No refresh in progress - hiding progress modal');
                        hideProgressModal();
                        // Clear any polling intervals
                        if (progressPollingInterval) {
                            clearInterval(progressPollingInterval);
                            progressPollingInterval = null;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error checking refresh status:', error);
            // Don't break the page if refresh status check fails
            const lastRefreshEl = document.getElementById('lastRefresh');
            if (lastRefreshEl) {
                lastRefreshEl.textContent = 'Last refresh: Unable to check';
            }
        }
    }
    
    // REMOVED: Duplicate checkRefreshStatus() call - it's already called in DOMContentLoaded above
    // checkRefreshStatus() only checks if a refresh is already in progress and shows the modal
    // It does NOT trigger a new refresh - refresh is ONLY triggered by:
    // 1. User clicking "Refresh Data Now" button (manualRefreshData function)
    // 2. Scheduled refresh (scheduler in main.py)
    
    // Check sync status and credentials
    async function checkSyncStatus() {
        try {
            const status = await apiRequest('/api/dashboard/sync-status');
            const syncStatusText = document.getElementById('syncStatusText');
            if (syncStatusText) {
                const syncStatus = status.status?.sync_status || 'unknown';
                const message = status.status?.message || '';
                
                if (syncStatus === 'synced') {
                    syncStatusText.textContent = '‚úÖ Database synced';
                    syncStatusText.style.color = '#28a745';
                } else if (syncStatus === 'outdated') {
                    syncStatusText.textContent = 'üîÑ Syncing newer data in background...';
                    syncStatusText.style.color = '#ffc107';
                } else if (syncStatus === 'missing') {
                    syncStatusText.textContent = 'üì• Downloading database...';
                    syncStatusText.style.color = '#007bff';
                } else {
                    syncStatusText.textContent = message || 'Sync status unknown';
                    syncStatusText.style.color = '#666';
                }
            }
            
            // Check and display credential warnings
            const missingCreds = status.status?.missing_credentials || [];
            const credMessage = status.status?.credentials_message || '';
            const credWarningBanner = document.getElementById('credentialWarningBanner');
            
            if (missingCreds.length > 0 && credWarningBanner) {
                credWarningBanner.style.display = 'block';
                const credWarningText = document.getElementById('credentialWarningText');
                if (credWarningText) {
                    credWarningText.innerHTML = `
                        <strong>‚ö†Ô∏è API Credentials Not Configured:</strong> ${missingCreds.join(' and ')} credentials are missing. 
                        <a href="/settings" style="color: #007bff; text-decoration: underline;">Configure credentials in Settings</a> 
                        to enable automatic data refresh.
                    `;
                }
            } else if (credWarningBanner) {
                credWarningBanner.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking sync status:', error);
        }
    }
    
    // Check sync status on load and every 30 seconds (reduced from 5s to reduce server load)
    // Only check sync status once on page load
    // Don't poll continuously - only check when user manually triggers refresh
    // This prevents unnecessary API calls and authentication errors
    checkSyncStatus();
    
    function toggleAllItems(type, checked) {
        const tableId = 'priorityTable';
        const checkboxes = document.querySelectorAll(`#${tableId} .item-checkbox`);
        checkboxes.forEach(cb => {
            cb.checked = checked;
            const index = parseInt(cb.dataset.index);
            togglePriorityOrderQuantityInput(index, checked);
        });
    }
    
    function togglePriorityOrderQuantityInput(index, enabled) {
        const input = document.querySelector(`.priority-order-qty-input[data-index="${index}"]`);
        const checkbox = document.querySelector(`#priorityTable .item-checkbox[data-index="${index}"]`);
        
        if (input) {
            if (enabled) {
                // Enable input
                input.disabled = false;
                input.style.backgroundColor = '#fff';
                input.style.cursor = 'text';
                input.title = 'Enter quantity in packs';
            } else {
                // Disable input and reset to default value
                input.disabled = true;
                input.style.backgroundColor = '#e9ecef';
                input.style.cursor = 'pointer';
                input.title = 'Click to edit quantity (auto-selects item)';
                
                // Reset to default value
                const defaultValue = input.dataset.defaultValue || '0.00';
                input.value = defaultValue;
                
                // Clear custom quantity from data
                if (window.priorityItemsData && window.priorityItemsData[index]) {
                    delete window.priorityItemsData[index].custom_order_quantity;
                }
            }
        }
        
        // Ensure checkbox state matches
        if (checkbox) {
            checkbox.checked = enabled;
        }
    }
    
    function updatePriorityOrderQuantity(index, value) {
        const checkbox = document.querySelector(`#priorityTable .item-checkbox[data-index="${index}"]`);
        
        // Ensure checkbox is checked when quantity is updated
        if (checkbox && !checkbox.checked) {
            checkbox.checked = true;
        }
        
        if (window.priorityItemsData && window.priorityItemsData[index]) {
            const quantity = parseFloat(value) || 0;
            window.priorityItemsData[index].custom_order_quantity = quantity;
            console.log(`Updated order quantity for priority item ${index}: ${quantity} packs`);
        }
    }
    
    function openProcurementModal() {
        const modal = document.getElementById('procurementModal');
        if (!modal) {
            console.error('‚ùå Procurement modal not found!');
            alert('Procurement modal not found. Please refresh the page.');
            return;
        }
        
        const targetBranch = document.getElementById('targetBranch')?.value || 'BABA DOGO HQ|NILA';
        const [targetBranchName, targetCompany] = targetBranch.split('|');
        
        // Store branch info in modal dataset
        modal.dataset.branch = targetBranchName;
        modal.dataset.company = targetCompany;
        
        // Load suppliers and branches
        loadSuppliers();
        loadDestinationBranches(targetBranchName, targetCompany);
        
        modal.style.display = 'block';
    }
    
    // Make closeProcurementModal globally accessible
    window.closeProcurementModal = function closeProcurementModal() {
        document.getElementById('procurementModal').style.display = 'none';
    };
    
    function toggleProcurementOptions() {
        const orderMode = document.querySelector('input[name="orderMode"]:checked').value;
        const supplierGroup = document.getElementById('supplierSelectionGroup');
        const branchGroup = document.getElementById('branchSelectionGroup');
        
        if (orderMode === 'purchase_order') {
            supplierGroup.style.display = 'block';
            branchGroup.style.display = 'none';
        } else {
            supplierGroup.style.display = 'none';
            branchGroup.style.display = 'block';
        }
    }
    
    async function loadSuppliers() {
        try {
            const targetBranch = document.getElementById('targetBranch')?.value || 'BABA DOGO HQ|NILA';
            const [targetBranchName, targetCompany] = targetBranch.split('|');
            
            // Get branch code for supplier API
            let branchCode = 1; // Default to BABA DOGO HQ
            if (targetCompany === 'DAIMA') {
                branchCode = 13; // DAIMA MERU WHOLESALE
            }
            
            const suppliers = await apiRequest(`/api/suppliers/list?bcode=${branchCode}`);
            window.suppliersList = suppliers || [];
            console.log(`Loaded ${window.suppliersList.length} suppliers`);
        } catch (error) {
            console.error('Error loading suppliers:', error);
            window.suppliersList = [];
        }
    }
    
    function searchSuppliers(searchTerm) {
        const dropdown = document.getElementById('supplierDropdown');
        dropdown.innerHTML = '';
        
        if (!searchTerm || searchTerm.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        const filtered = (window.suppliersList || []).filter(s => 
            s.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            s.code.toLowerCase().includes(searchTerm.toLowerCase())
        ).slice(0, 10);
        
        if (filtered.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        
        filtered.forEach(supplier => {
            const item = document.createElement('div');
            item.className = 'supplier-dropdown-item';
            item.textContent = `${supplier.name} (${supplier.code})`;
            item.onclick = () => selectSupplier(supplier.code, supplier.name);
            dropdown.appendChild(item);
        });
        
        dropdown.style.display = 'block';
    }
    
    function selectSupplier(code, name) {
        document.getElementById('selectedSupplierCode').value = code;
        document.getElementById('selectedSupplierName').value = name;
        document.getElementById('selectedSupplierText').textContent = `${name} (${code})`;
        document.getElementById('selectedSupplierDisplay').style.display = 'block';
        document.getElementById('supplierSearch').value = '';
        document.getElementById('supplierDropdown').style.display = 'none';
    }
    
    function showSupplierDropdown() {
        const dropdown = document.getElementById('supplierDropdown');
        const searchTerm = document.getElementById('supplierSearch').value;
        if (searchTerm && searchTerm.length >= 2) {
            searchSuppliers(searchTerm);
        }
    }
    
    function hideSupplierDropdown() {
        // Delay hiding to allow click events
        setTimeout(() => {
            document.getElementById('supplierDropdown').style.display = 'none';
        }, 200);
    }
    
    async function loadDestinationBranches(currentBranch, currentCompany) {
        try {
            console.log(`Loading destination branches for target: ${currentBranch} (${currentCompany})`);
            const response = await apiRequest('/api/dashboard/branches');
            const select = document.getElementById('destinationBranchSelect');
            select.innerHTML = '<option value="">-- Select Branch --</option>';
            
            const branches = response.data || response.branches || [];
            
            if (!response.success || branches.length === 0) {
                console.warn('No branches found in API response:', response);
                select.innerHTML = '<option value="">No branches available</option>';
                return;
            }
            
            const filteredBranches = branches.filter(branch => {
                const branchCompany = (branch.company || '').trim().toUpperCase();
                const targetCompany = (currentCompany || '').trim().toUpperCase();
                
                if (branchCompany !== targetCompany) {
                    return false;
                }
                
                const branchName = (branch.branch_name || '').trim();
                const targetBranch = (currentBranch || '').trim();
                
                if (branchName === targetBranch) {
                    return false;
                }
                
                return true;
            });
            
            console.log(`Found ${filteredBranches.length} branches for ${currentCompany} (excluding current branch)`);
            
            if (filteredBranches.length === 0) {
                select.innerHTML = `<option value="">No other ${currentCompany} branches available</option>`;
                return;
            }
            
            filteredBranches.forEach(branch => {
                const option = document.createElement('option');
                const branchName = branch.branch_name || '';
                const branchCompany = branch.company || '';
                option.value = `${branchName}|${branchCompany}`;
                option.textContent = branchName; // Display only branch name, no company in brackets
                option.dataset.branchCode = branch.branch_code || branch.branchcode || '';
                select.appendChild(option);
            });
            
            console.log(`Successfully loaded ${filteredBranches.length} destination branches`);
        } catch (error) {
            console.error('Error loading destination branches:', error);
            const select = document.getElementById('destinationBranchSelect');
            select.innerHTML = '<option value="">Error loading branches</option>';
        }
    }
    
    // Make runProcurementBot globally accessible
    window.runProcurementBot = async function runProcurementBot(type) {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('Please login first');
            window.location.href = '/';
            return;
        }
        
        // Get selected items
        const tableId = 'priorityTable';
        const checkboxes = document.querySelectorAll(`#${tableId} .item-checkbox:checked`);
        
        if (checkboxes.length === 0) {
            alert('Please select at least one item to order');
            return;
        }
        
        // Get items data with custom order quantities
        const itemsData = window.priorityItemsData;
        const selectedItems = Array.from(checkboxes).map(cb => {
            const index = parseInt(cb.dataset.index);
            const item = { ...itemsData[index] }; // Copy item
            
            // Get custom order quantity from input field
            const qtyInput = document.querySelector(`.priority-order-qty-input[data-index="${index}"]`);
            if (qtyInput && qtyInput.value) {
                const customQty = parseFloat(qtyInput.value) || 0;
                item.custom_order_quantity = customQty;
                console.log(`Using custom order quantity for ${item.item_code}: ${customQty} packs`);
            } else {
                // Use AMC as fallback
                const packSize = parseFloat(item.pack_size) || 1;
                const amcPieces = parseFloat(item.amc) || 0;
                const amcPacks = packSize > 0 ? amcPieces / packSize : 0;
                item.custom_order_quantity = amcPacks;
                console.log(`Using AMC as order quantity for ${item.item_code}: ${amcPacks} packs`);
            }
            
            return item;
        });
        
        // Open procurement modal
        openProcurementModal();
        
        // Store selected items in modal dataset for later use
        document.getElementById('procurementModal').dataset.selectedItems = JSON.stringify(selectedItems);
    }
    
    // Make confirmProcurementOrder globally accessible
    window.confirmProcurementOrder = async function confirmProcurementOrder() {
        const modal = document.getElementById('procurementModal');
        const branch = modal.dataset.branch;
        const company = modal.dataset.company;
        
        // Get selected items from modal dataset
        const selectedItems = JSON.parse(modal.dataset.selectedItems || '[]');
        
        if (selectedItems.length === 0) {
            alert('No items selected');
            return;
        }
        
        // Get order mode
        const orderMode = document.querySelector('input[name="orderMode"]:checked').value;
        
        // Get credentials (required for accountability)
        const procurementCompany = document.getElementById('procurementCompany').value;
        const procurementUsername = document.getElementById('procurementUsername').value;
        const procurementPassword = document.getElementById('procurementPassword').value;
        
        if (!procurementCompany || !procurementUsername || !procurementPassword) {
            alert('Please provide API credentials (Company, Username, and Password)');
            return;
        }
        
        // Get source branch (for branch orders)
        const sourceBranchValue = document.getElementById('sourceBranch')?.value || `${branch}|${company}`;
        const [sourceBranch, sourceCompany] = sourceBranchValue.split('|').map(s => s.trim());
        
        // Validate based on order mode
        if (orderMode === 'purchase_order') {
            // Validate supplier selection
            const supplierCode = document.getElementById('selectedSupplierCode').value;
            const supplierName = document.getElementById('selectedSupplierName').value;
            
            if (!supplierCode || !supplierName) {
                alert('Please select a supplier for the purchase order');
                return;
            }
            
            // Batch items if more than 20
            await createBatchedOrders(selectedItems, branch, company, sourceBranch, sourceCompany, 'purchase_order', supplierCode, supplierName, procurementCompany, procurementUsername, procurementPassword);
        } else {
            // Branch order mode
            const destinationBranchValue = document.getElementById('destinationBranchSelect').value;
            if (!destinationBranchValue) {
                alert('Please select a destination branch for the branch order');
                return;
            }
            
            const [destBranch, destCompany] = destinationBranchValue.split('|').map(s => s.trim());
            
            // Batch items if more than 20
            await createBatchedOrders(selectedItems, branch, company, destBranch, destCompany, 'branch_order', null, null, procurementCompany, procurementUsername, procurementPassword);
        }
    };
    
    async function createBatchedOrders(selectedItems, branch, company, sourceBranch, sourceCompany, orderMode, supplierCode = null, supplierName = null, procurementCompany = null, procurementUsername = null, procurementPassword = null) {
        const BATCH_SIZE = 20;
        const batches = [];
        
        // Split items into batches of max 20
        for (let i = 0; i < selectedItems.length; i += BATCH_SIZE) {
            batches.push(selectedItems.slice(i, i + BATCH_SIZE));
        }
        
        console.log(`Creating ${batches.length} batch(es) for ${selectedItems.length} items`);
        
        let totalSuccess = 0;
        let totalFailed = 0;
        const orderNumbers = [];
        
        // Process each batch
        for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
            const batch = batches[batchIndex];
            const batchNum = batchIndex + 1;
            
            try {
                const requestBody = {
                    items: batch,
                    branch_name: branch,
                    branch_company: company,
                    source_branch_name: sourceBranch,
                    source_branch_company: sourceCompany,
                    order_mode: orderMode,
                    manual_selection: true,
                    company: procurementCompany,
                    username: procurementUsername,
                    password: procurementPassword
                };
                
                if (orderMode === 'purchase_order' && supplierCode && supplierName) {
                    requestBody.supplier_code = supplierCode;
                    requestBody.supplier_name = supplierName;
                }
                
                console.log(`Creating batch ${batchNum}/${batches.length} with ${batch.length} items...`);
                
                const result = await apiRequest('/api/procurement/run', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });
                
                if (result.success) {
                    totalSuccess += result.successful_orders || batch.length;
                    if (result.order_number) {
                        orderNumbers.push(result.order_number);
                    }
                    console.log(`‚úÖ Batch ${batchNum} completed: ${result.successful_orders || batch.length} items`);
                } else {
                    totalFailed += batch.length;
                    console.error(`‚ùå Batch ${batchNum} failed: ${result.message}`);
                }
            } catch (error) {
                totalFailed += batch.length;
                console.error(`‚ùå Batch ${batchNum} error:`, error);
            }
        }
        
        // Show summary
        const orderType = orderMode === 'purchase_order' ? 'Purchase Order' : 'Branch Order';
        let message = `‚úÖ ${orderType} Creation Complete!\n\n`;
        message += `Total Items: ${selectedItems.length}\n`;
        message += `Successful: ${totalSuccess}\n`;
        message += `Failed: ${totalFailed}\n`;
        message += `Batches: ${batches.length}\n`;
        if (orderNumbers.length > 0) {
            message += `\nOrder Numbers:\n${orderNumbers.join('\n')}`;
        }
        
        alert(message);
        closeProcurementModal();
        
        // Reload priority items to reflect new orders
        loadPriorityItems();
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('procurementModal');
        if (event.target === modal) {
            closeProcurementModal();
        }
    }
    
    // Store current sort state for dashboard tables
    let dashboardSort = { priority: { column: null, direction: null } };
    
    // Make showFilter globally accessible
    window.showFilter = function showFilter(tableType, column, event) {
        if (event) {
            event.stopPropagation();
        }
        
        // Create dropdown menu
        const menu = document.createElement('div');
        menu.style.cssText = 'position: absolute; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000; padding: 5px 0; min-width: 200px;';
        
        // Determine column type
        const isDateColumn = column.toLowerCase().includes('date') || column.toLowerCase().includes('time');
        const isNumericColumn = column.toLowerCase().includes('stock') || column.toLowerCase().includes('amc') || 
                               column.toLowerCase().includes('level') || column.toLowerCase().includes('pct') ||
                               column.toLowerCase().includes('pieces') || column.toLowerCase().includes('packs');
        
        // Add sort options
        const options = [];
        
        if (isDateColumn) {
            options.push({ label: 'üîº Newest to Oldest', value: 'desc' });
            options.push({ label: 'üîΩ Oldest to Newest', value: 'asc' });
        } else if (isNumericColumn) {
            options.push({ label: 'üî¢ High to Low', value: 'desc' });
            options.push({ label: 'üî¢ Low to High', value: 'asc' });
        } else {
            options.push({ label: 'üî§ A to Z', value: 'asc' });
            options.push({ label: 'üî§ Z to A', value: 'desc' });
        }
        
        options.push({ label: '‚ùå Clear Sort', value: 'clear' });
        
        options.forEach(opt => {
            const item = document.createElement('div');
            item.style.cssText = 'padding: 8px 15px; cursor: pointer; font-size: 14px;';
            item.textContent = opt.label;
            item.onmouseover = () => item.style.background = '#f0f0f0';
            item.onmouseout = () => item.style.background = 'white';
            item.onclick = () => {
                if (opt.value === 'clear') {
                    sortDashboardTable(tableType, column, null);
                } else {
                    sortDashboardTable(tableType, column, opt.value);
                }
                document.body.removeChild(menu);
            };
            menu.appendChild(item);
        });
        
        // Position menu near click
        if (event) {
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
        } else {
            menu.style.left = '50%';
            menu.style.top = '50%';
        }
        
        document.body.appendChild(menu);
        
        // Close menu when clicking outside
        setTimeout(() => {
            const closeMenu = (e) => {
                if (!menu.contains(e.target) && e.target !== event?.target) {
                    if (document.body.contains(menu)) {
                        document.body.removeChild(menu);
                    }
                    document.removeEventListener('click', closeMenu);
                }
            };
            document.addEventListener('click', closeMenu);
        }, 100);
    };
    
    // Make sortDashboardTable globally accessible
    window.sortDashboardTable = function sortDashboardTable(tableType, column, direction) {
        let tbody, dataArray, dataKey;
        
        if (tableType === 'priority') {
            tbody = document.getElementById('priorityBody');
            dataArray = window.priorityItemsData;
            dataKey = 'priorityItemsData';
        } else {
            return;
        }
        
        if (!tbody || !dataArray || dataArray.length === 0) return;
        
        // Clear sort
        if (!direction) {
            dashboardSort['priority'] = { column: null, direction: null };
            // Reload original data
            loadPriorityItems();
            return;
        }
        
        // Store sort state
        dashboardSort['priority'] = { column, direction };
        
        // Map column names to data keys
        const columnMap = {
            'item_code': 'item_code',
            'item_name': 'item_name',
            'stock': 'stock_pieces',
            'invoice_date': 'invoice_date',
            'hq_stock': 'source_stock_packs',
            'branch': 'branch_name',
            'branch_stock': 'target_stock_packs',
            'abc_class': 'abc_class',
            'stock_level': 'stock_level_pct',
            'amc': 'amc_packs',
            'last_order_date': 'last_order_date'
        };
        
        const dataKeyName = columnMap[column] || column;
        
        // Determine column type
        const isDateColumn = column.toLowerCase().includes('date') || column.toLowerCase().includes('time');
        const isNumericColumn = column.toLowerCase().includes('stock') || column.toLowerCase().includes('amc') || 
                               column.toLowerCase().includes('level') || column.toLowerCase().includes('pct') ||
                               column.toLowerCase().includes('pieces') || column.toLowerCase().includes('packs');
        
        // Sort data array
        const sortedData = [...dataArray].sort((a, b) => {
            let aVal = a[dataKeyName] || '';
            let bVal = b[dataKeyName] || '';
            
            // Handle dates
            if (isDateColumn) {
                aVal = aVal ? new Date(aVal) : new Date(0);
                bVal = bVal ? new Date(bVal) : new Date(0);
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }
            
            // Handle numbers
            if (isNumericColumn) {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }
            
            // Handle text
            aVal = String(aVal).toLowerCase();
            bVal = String(bVal).toLowerCase();
            if (direction === 'asc') {
                return aVal.localeCompare(bVal);
            } else {
                return bVal.localeCompare(aVal);
            }
        });
        
        // Update window data
        window[dataKey] = sortedData;
        
        // Rebuild table rows
        tbody.innerHTML = '';
        
        if (tableType === 'new_arrivals') {
            sortedData.forEach((item, index) => {
                const row = tbody.insertRow();
                
                const checkboxCell = row.insertCell(0);
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'item-checkbox';
                checkbox.dataset.index = index;
                checkboxCell.appendChild(checkbox);
                
                row.insertCell(1).textContent = item.item_code || '';
                row.insertCell(2).textContent = item.item_name || '';
                
                const stockPieces = parseFloat(item.stock_pieces || item.branch_stock_pieces || 0);
                const stockCell = row.insertCell(3);
                stockCell.textContent = stockPieces.toFixed(0);
                if (stockPieces === 0) {
                    stockCell.classList.add('stock-zero');
                } else if (stockPieces < 10) {
                    stockCell.classList.add('stock-low');
                } else {
                    stockCell.classList.add('stock-good');
                }
                
                const invoiceDateRaw = item.invoice_date || item.document_date || null;
                const invoiceDateFormatted = formatDate(invoiceDateRaw);
                row.insertCell(4).textContent = invoiceDateFormatted;
            });
        } else {
            // Priority items table
            sortedData.forEach((item, index) => {
                const row = tbody.insertRow();
                
                const checkboxCell = row.insertCell(0);
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'item-checkbox';
                checkbox.dataset.index = index;
                checkboxCell.appendChild(checkbox);
                
                row.insertCell(1).textContent = item.item_code || '';
                row.insertCell(2).textContent = item.item_name || '';
                
                const hqStock = parseFloat(item.source_stock_packs || item.hq_stock_packs || 0);
                const hqCell = row.insertCell(3);
                hqCell.textContent = hqStock.toFixed(0);
                if (hqStock === 0) {
                    hqCell.classList.add('stock-zero');
                } else if (hqStock < 10) {
                    hqCell.classList.add('stock-low');
                } else {
                    hqCell.classList.add('stock-good');
                }
                
                row.insertCell(4).textContent = item.branch_name || item.target_branch || '';
                
                const branchStock = parseFloat(item.target_stock_packs || item.branch_stock_packs || 0);
                const branchStockCell = row.insertCell(5);
                branchStockCell.textContent = branchStock.toFixed(0);
                if (branchStock === 0) {
                    branchStockCell.classList.add('stock-zero');
                } else if (branchStock < 10) {
                    branchStockCell.classList.add('stock-low');
                } else {
                    branchStockCell.classList.add('stock-good');
                }
                
                const abcClass = item.abc_class || '';
                const abcCell = row.insertCell(6);
                abcCell.textContent = abcClass;
                if (abcClass === 'A') {
                    abcCell.classList.add('abc-class-a');
                } else if (abcClass === 'B') {
                    abcCell.classList.add('abc-class-b');
                } else if (abcClass === 'C') {
                    abcCell.classList.add('abc-class-c');
                }
                
                const stockLevel = parseFloat(item.stock_level_pct || 0);
                const stockLevelCell = row.insertCell(7);
                stockLevelCell.textContent = stockLevel.toFixed(1) + '%';
                if (stockLevel < 20) {
                    stockLevelCell.classList.add('stock-pct-critical');
                } else if (stockLevel < 30) {
                    stockLevelCell.classList.add('stock-pct-warning');
                } else {
                    stockLevelCell.classList.add('stock-pct-good');
                }
                
                const amc = parseFloat(item.amc_packs || item.amc || 0);
                row.insertCell(8).textContent = amc.toFixed(2);
                
                const lastOrderDateRaw = item.last_order_date || null;
                const dateCell = row.insertCell(10);
                const formattedDate = formatDate(lastOrderDateRaw);
                dateCell.textContent = formattedDate;
                
                if (lastOrderDateRaw && lastOrderDateRaw !== 'Never' && lastOrderDateRaw !== null) {
                    try {
                        const orderDate = new Date(lastOrderDateRaw);
                        if (!isNaN(orderDate.getTime())) {
                            const daysAgo = (new Date() - orderDate) / (1000 * 60 * 60 * 24);
                            if (daysAgo >= 0 && daysAgo <= 7) {
                                row.classList.add('priority-item-recent');
                            }
                        }
                    } catch (e) {
                        // Invalid date format, skip
                    }
                }
            });
        }
        
        // Show procurement button if items exist
        const btn = document.getElementById('priorityProcurementBtn');
        if (btn && sortedData.length > 0) {
            btn.style.display = 'inline-block';
        }
    }
    
    // Database Status Check Functions
    async function checkDatabaseStatus() {
        try {
            const diagnostics = await apiRequest('/api/dashboard/diagnostics');
            if (diagnostics.success && diagnostics.diagnostics) {
                const summary = diagnostics.diagnostics.summary || {};
                return summary.has_stock_data || false;
            }
            return false;
        } catch (error) {
            console.error('Error checking database status:', error);
            return false;
        }
    }
    
    function showEmptyDatabaseMessage() {
        // Show message in priority items table
        const tbody = document.getElementById('priorityBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="empty" style="padding: 40px; text-align: center;">
                        <div style="font-size: 20px; margin-bottom: 15px;">üëã Welcome to PharmaStock!</div>
                        <div style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                            <p style="font-size: 16px; margin-bottom: 10px;"><strong>No data available yet.</strong></p>
                            <p>To get started:</p>
                            <ol style="text-align: left; display: inline-block; margin-top: 10px;">
                                <li>Make sure API credentials are configured in <strong>Settings</strong></li>
                                <li>Click the <strong>"Refresh All Data"</strong> button above</li>
                                <li>Wait for the refresh to complete (progress will be shown)</li>
                                <li>Data will appear automatically when ready</li>
                            </ol>
                        </div>
                        <button onclick="triggerRefresh()" class="btn-refresh" style="padding: 12px 24px; font-size: 16px; margin-top: 10px;">
                            üîÑ Start First Data Refresh
                        </button>
                        <div style="margin-top: 15px; font-size: 12px; color: #999;">
                            <strong>Note:</strong> First refresh may take 2-5 minutes as it fetches data from APIs and saves to Supabase database.
                            <br>You'll see a progress window showing each step.
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    // Search functionality for priority table
    // Make filterPriorityTable globally accessible
    window.filterPriorityTable = function filterPriorityTable() {
        const searchTerm = document.getElementById('prioritySearch')?.value.toLowerCase() || '';
        const tbody = document.getElementById('priorityBody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 2) {
                row.style.display = '';
                return;
            }
            
            const itemCode = (cells[1]?.textContent || '').toLowerCase();
            const itemName = (cells[2]?.textContent || '').toLowerCase();
            
            if (!searchTerm || itemCode.includes(searchTerm) || itemName.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Save search term to localStorage
        try {
            localStorage.setItem('prioritySearchTerm', searchTerm);
        } catch (e) {
            console.warn('Could not save search term:', e);
        }
    };
    
    // State persistence functions
    function savePriorityState() {
        try {
            const state = {
                selectedItems: Array.from(document.querySelectorAll('#priorityBody input[type="checkbox"]:checked')).map(cb => cb.dataset.index),
                scrollPosition: document.querySelector('.table-container')?.scrollTop || 0,
                searchTerm: document.getElementById('prioritySearch')?.value || '',
                targetBranch: document.getElementById('targetBranch')?.value || '',
                sourceBranch: document.getElementById('sourceBranch')?.value || '',
                limit: document.getElementById('priorityLimit')?.value || '50',
                orderQuantities: {}
            };
            
            // Save order quantities
            document.querySelectorAll('#priorityBody input.order-qty-input').forEach(input => {
                if (input.value) {
                    state.orderQuantities[input.dataset.index] = input.value;
                }
            });
            
            localStorage.setItem('priorityTableState', JSON.stringify(state));
        } catch (e) {
            console.warn('Could not save priority state:', e);
        }
    }
    
    function restorePriorityState() {
        try {
            const stateStr = localStorage.getItem('priorityTableState');
            if (!stateStr) return;
            
            const state = JSON.parse(stateStr);
            
            // Restore branch selections
            if (state.targetBranch && document.getElementById('targetBranch')) {
                document.getElementById('targetBranch').value = state.targetBranch;
            }
            if (state.sourceBranch && document.getElementById('sourceBranch')) {
                document.getElementById('sourceBranch').value = state.sourceBranch;
            }
            if (state.limit && document.getElementById('priorityLimit')) {
                document.getElementById('priorityLimit').value = state.limit;
            }
            if (state.searchTerm && document.getElementById('prioritySearch')) {
                document.getElementById('prioritySearch').value = state.searchTerm;
            }
            
            // Restore scroll position after data loads
            setTimeout(() => {
                const container = document.querySelector('.table-container');
                if (container && state.scrollPosition) {
                    container.scrollTop = state.scrollPosition;
                }
            }, 500);
        } catch (e) {
            console.warn('Could not restore priority state:', e);
        }
    }
    
    // Save state periodically and on changes
    setInterval(savePriorityState, 2000); // Save every 2 seconds
    document.addEventListener('change', (e) => {
        if (e.target.matches('#priorityBody input[type="checkbox"], #priorityBody input.order-qty-input')) {
            savePriorityState();
        }
    });
    
    // Restore state on page load
    window.addEventListener('DOMContentLoaded', () => {
        restorePriorityState();
    });
</script>
{% endblock %}

