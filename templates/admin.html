{% extends "base.html" %}

{% block title %}Admin - PharmaStock{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>üë§ Admin Panel</h1>
    
    <div class="card">
        <div class="card-header">User Management</div>
        
        <div class="form-group">
            <label>Create New User</label>
            <div style="margin-bottom: 15px; padding: 15px; background: #e7f3ff; border-radius: 5px; border: 1px solid #b3d9ff;">
                <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
                    <strong>Username Format:</strong> Use format like <code>DR-JACKSON</code> (uppercase, hyphen-separated)<br>
                    <strong>Password:</strong> Use a PIN like <code>1996</code> (numbers only, 4-6 digits recommended)
                </p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="newUsername" placeholder="DR-JACKSON" required style="text-transform: uppercase;">
                <input type="password" id="newPassword" placeholder="1996" required pattern="[0-9]{4,6}" title="Enter a 4-6 digit PIN">
                <input type="number" id="newSubscriptionDays" placeholder="Days" min="1" value="30" required>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; white-space: nowrap;">
                    <input type="checkbox" id="newIsUserAdmin" style="width: auto;">
                    User Admin
                </label>
                <button onclick="createUser()" class="btn btn-success">Create User</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                <strong>User Admin:</strong> Can create users, block users, and configure API credentials. 
                <strong>Note:</strong> Only super admin (9542) can create full admins.
            </p>
        </div>
        
        <div id="usersList" class="loading">Loading...</div>
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        // Check if user is authenticated and is admin or user_admin
        const token = localStorage.getItem('access_token');
        const isAdmin = localStorage.getItem('is_admin') === 'true';
        const isUserAdmin = localStorage.getItem('is_user_admin') === 'true';
        
        if (!token) {
            console.warn('No access token found, redirecting to login');
            window.location.href = '/';
            return;
        }
        
        // Allow access if user is admin or user_admin
        if (!isAdmin && !isUserAdmin) {
            console.warn('User is not admin or user_admin, redirecting to dashboard');
            window.location.href = '/dashboard';
            return;
        }
        
        // Load users
        loadUsers();
    });
    
    async function apiRequest(url, options = {}) {
        const token = localStorage.getItem('access_token');
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        };
        
        const response = await fetch(url, { ...defaultOptions, ...options });
        
        if (response.status === 401) {
            localStorage.removeItem('access_token');
            window.location.href = '/';
            return null;
        }
        
        return await response.json();
    }
    
    async function loadUsers() {
        try {
            const data = await apiRequest('/api/admin/users/list');
            
            if (data && data.success && data.users) {
                let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;"><thead><tr style="background: #f5f5f5;"><th style="padding: 10px; text-align: left;">Username</th><th style="padding: 10px; text-align: left;">Status</th><th style="padding: 10px; text-align: left;">Days Remaining</th><th style="padding: 10px; text-align: left;">Actions</th></tr></thead><tbody>';
                
                data.users.forEach(user => {
                    const statusBadge = user.subscription_valid ? 
                        '<span style="color: green;">‚úÖ Active</span>' : 
                        '<span style="color: red;">‚ùå Expired</span>';
                    const adminBadge = user.is_admin ? ' <span style="color: #ff9800;">(Admin)</span>' : '';
                    
                    html += `
                        <tr>
                            <td style="padding: 10px;">${user.username}${adminBadge}</td>
                            <td style="padding: 10px;">${statusBadge}</td>
                            <td style="padding: 10px;">${user.days_remaining} days</td>
                            <td style="padding: 10px;">
                                <input type="number" id="days_${user.username}" placeholder="Days" style="width: 80px; padding: 5px; margin-right: 5px;" min="1">
                                <button onclick="updateSubscription('${user.username}')" class="btn btn-primary" style="padding: 5px 10px; margin-right: 5px;">Update</button>
                                ${!user.is_admin ? `<button onclick="toggleUser('${user.username}', ${user.active})" class="btn ${user.active ? 'btn-warning' : 'btn-success'}" style="padding: 5px 10px; margin-right: 5px;">${user.active ? 'Deactivate' : 'Activate'}</button>` : '<span style="color: #999;">N/A</span>'}
                                ${!user.is_admin ? `<button onclick="deleteUser('${user.username}')" class="btn btn-danger" style="padding: 5px 10px;">Delete</button>` : '<span style="color: #999;">N/A</span>'}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('usersList').innerHTML = html;
            } else {
                document.getElementById('usersList').innerHTML = '<p style="color: #666;">No users found or error loading users.</p>';
            }
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('usersList').innerHTML = `<p style="color: #dc3545;">Error loading users: ${error.message}</p>`;
        }
    }
    
    async function createUser() {
        const username = document.getElementById('newUsername').value.trim().toUpperCase();
        const password = document.getElementById('newPassword').value;
        const subscriptionDays = parseInt(document.getElementById('newSubscriptionDays').value);
        
        // Validate username format (DR-NAME format)
        if (!username || !/^[A-Z0-9]+(-[A-Z0-9]+)*$/.test(username)) {
            alert('‚ùå Username must be in format like DR-JACKSON (uppercase letters/numbers, hyphen-separated)');
            return;
        }
        
        // Validate password (PIN format - numbers only)
        if (!password || !/^\d{4,6}$/.test(password)) {
            alert('‚ùå Password must be a 4-6 digit PIN (numbers only, e.g., 1996)');
            return;
        }
        
        if (!subscriptionDays || subscriptionDays < 1) {
            alert('Please enter a valid number of subscription days');
            return;
        }
        
        const isUserAdmin = document.getElementById('newIsUserAdmin').checked;
        const isSuperAdmin = localStorage.getItem('user_username') === '9542';
        
        try {
            const result = await apiRequest('/api/admin/users/create', {
                method: 'POST',
                body: JSON.stringify({
                    username, 
                    password, 
                    subscription_days: subscriptionDays,
                    is_admin: false,  // Only super admin can create full admins
                    is_user_admin: isUserAdmin  // Allow creating user_admin users
                })
            });
            
            if (result.success) {
                alert(`‚úÖ User "${username}" created successfully!`);
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('newSubscriptionDays').value = '30';
                loadUsers();
            } else {
                alert(`‚ùå Failed: ${result.message || result.detail}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }
    
    async function updateSubscription(username) {
        const daysInput = document.getElementById(`days_${username}`);
        const subscriptionDays = parseInt(daysInput.value);
        
        if (!subscriptionDays || subscriptionDays < 1) {
            alert('Please enter a valid number of days');
            return;
        }
        
        try {
            const result = await apiRequest('/api/admin/users/update-subscription', {
                method: 'POST',
                body: JSON.stringify({ username, subscription_days: subscriptionDays })
            });
            
            if (result.success) {
                alert('‚úÖ Subscription updated successfully');
                daysInput.value = '';
                loadUsers();
            } else {
                alert(`‚ùå Failed: ${result.message || result.detail}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }
    
    async function toggleUser(username, currentlyActive) {
        const action = currentlyActive ? 'deactivate' : 'activate';
        if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} user ${username}?`)) {
            return;
        }
        
        try {
            const endpoint = currentlyActive ? '/api/admin/users/deactivate' : '/api/admin/users/activate';
            const result = await apiRequest(endpoint, {
                method: 'POST',
                body: JSON.stringify({ username })
            });
            
            if (result.success) {
                alert(`‚úÖ User ${action}d successfully`);
                loadUsers();
            } else {
                alert(`‚ùå Failed: ${result.message || result.detail}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }
    
    async function deleteUser(username) {
        if (!confirm(`‚ö†Ô∏è WARNING: This will permanently delete user "${username}". This action cannot be undone.\n\nAre you sure?`)) {
            return;
        }
        
        try {
            const result = await apiRequest('/api/admin/users/delete', {
                method: 'POST',
                body: JSON.stringify({ username })
            });
            
            if (result.success) {
                alert(`‚úÖ User deleted successfully`);
                loadUsers();
            } else {
                alert(`‚ùå Failed: ${result.message || result.detail}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }
</script>
{% endblock %}
